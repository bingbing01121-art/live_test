# 项目介绍：Live Stream Test

## 核心功能

这是一个基于 WebRTC 和 WebSocket 的多房间实时视频直播应用。它允许一个主播向多个观众进行视频直播，并包含基本的房间管理和互动功能。

项目主要由三部分组成：

1.  **信令服务器 (`server.js`)**
2.  **主播端 (`broadcaster.html`)**
3.  **观众端 (`viewer.html`)**

---

## 技术栈

-   **前端:** HTML, CSS, JavaScript
-   **后端:** Node.js
-   **实时通信:**
    -   **WebRTC:** 用于在主播和观众之间建立点对点（P2P）连接，以低延迟传输音视频流和数据。
    -   **WebSocket:** 用于信令传输，即在 WebRTC 连接建立之前，客户端之间交换元数据（如 `offer`, `answer`, `candidate`）。
-   **主要依赖库:**
    -   `ws`: 在 Node.js 环境中实现 WebSocket 信令服务器。
    -   `uuid`: 用于生成唯一的 ID，以标识用户和房间。

---

## 功能明细

### 1. 信令服务器 (`server.js`)

-   **用户管理:**
    -   为每个连接的客户端（主播或观众）分配一个唯一的临时 ID。
    -   允许客户端注册一个持久的 ID 和用户名，即使用户断开重连也能保持身份。
-   **房间管理:**
    -   **创建房间:** 主播可以创建一个新的直播间。
    -   **列出房间:** 观众可以获取当前所有可用的直播间列表。
    -   **加入/离开房间:** 观众可以加入或离开一个直播间。
    -   **关闭房间:** 当主播断开连接时，服务器会自动关闭房间并通知所有观众。
-   **WebRTC 信令:**
    -   在对等端之间可靠地转发 `offer`, `answer`, 和 `ice candidate` 消息，以协商 P2P 连接。
-   **主播权限管理:**
    -   **禁言/解禁:** 允许主播将指定观众禁言或解除禁言（观众端将无法发送聊天消息）。
    -   **踢出用户:** 允许主播将指定观众从直播间中移除。
    -   **主播静音状态:** 广播主播的麦克风静音/取消静音状态给所有观众。

### 2. 主播端 (`broadcaster.html`)

-   **用户身份:**
    -   首次访问时提示输入用户名，并生成一个持久的 UUID 存储在本地 (`localStorage`)。
-   **媒体捕获:**
    -   使用 `navigator.mediaDevices.getUserMedia` API 访问并捕获用户的摄像头和麦克风。
    -   在页面上的 `<video>` 元素中显示本地视频预览。
-   **直播流程:**
    -   创建并开始直播，向信令服务器注册一个新房间。
    -   为每一个新加入的观众创建独立的 `RTCPeerConnection`。
    -   将本地音视频流通过 WebRTC 发送给所有连接的观众。
-   **观众管理:**
    -   实时显示当前房间的观众列表。
    -   提供 "禁言/解禁" 和 "踢出" 按钮来管理观众。
-   **互动:**
    -   通过 `RTCDataChannel` 与观众进行实时文字聊天（弹幕）。
-   **直播控制:**
    -   可以随时 "结束直播"。
    -   可以 "静音" 或 "取消静音" 自己的麦克风。

### 3. 观众端 (`viewer.html`)

-   **用户身份:**
    -   与主播端类似，通过 `localStorage` 管理用户身份。
-   **房间浏览和加入:**
    -   连接到信令服务器后，自动获取并显示所有活跃的直播间列表。
    -   点击 "加入" 按钮进入指定的直播间。
-   **视频播放:**
    -   接收主播的 WebRTC `offer`，创建并返回 `answer`，最终建立 P2P 连接。
    -   通过建立的连接接收主播的音视频流，并在页面的 `<video>` 元素中播放。
-   **互动:**
    -   通过 `RTCDataChannel` 接收并显示主播和其他观众的弹幕消息。
    -   可以发送弹幕消息。如果被主播禁言，输入框将被禁用。
-   **状态处理:**
    -   如果主播结束直播或自己被踢出房间，会收到提示并返回到房间列表界面。
    -   能接收到主播的静音状态并在日志中显示。

---

## 如何运行

1.  **安装依赖:**
    ```bash
    npm install
    ```
2.  **启动服务器:**
    ```bash
    npm start
    ```
    服务器将默认在 `8088` 端口上运行。

3.  **开始直播:**
    -   在浏览器中打开 `broadcaster.html` 文件。
    -   输入用户名和房间名，然后点击 "创建并开始直播"。

4.  **观看直播:**
    -   在另一个浏览器标签页或另一台设备上打开 `viewer.html` 文件。
    -   从房间列表中选择一个直播间加入。
